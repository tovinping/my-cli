#!/usr/bin/env node
const program = require('commander')
const shelljs = require('shelljs')
const chalk = require('chalk')
const inquirer = require('inquirer')
const ora = require('ora')
const download = require('download-git-repo')
const reactRepo = 'direct:https://github.com/tovinping/webpack4-init-react.git'
const vueRepo = 'direct:https://github.com/tovinping/webpack4-init-vue.git'
const actionHandle = {
  init(opt){
    inquirer.prompt([
  {
    name: 'testName',
    type: 'input',
    message: 'è¯·è¾“å…¥åå­—å‘€',
    default: 'testName'
  },{
    name: 'name',
    type: 'list',
    message: 'è¯·é€‰æ‹©é¡¹ç›®ç±»åž‹react|vue',
    choices: ['react','vue'],
    default: 'react'
  },{
    name: 'like',
    type: 'checkbox',
    message: 'å“ˆå“ˆå“ˆ,è¿™ä¸ªæ²¡æœ‰å®žé™…æ„ä¹‰ï¼Œæµ‹è¯•çŽ©çŽ©',
    choices: ['è‹¹æžœ','é¦™è•‰','æ©˜å­']
  },{
    name: 'confirm',
    type: 'confirm',
    message: 'è¯·ä»”ç»†ç¡®è®¤ä½ çš„é€‰é¡¹(æ²¡æœ‰å®žé™…æ„ä¹‰)'
  }]).then(res=> {
      console.log(res)
      console.log('params', opt)
      console.log('try?', program.try)
      const spinner = ora(`ðŸºæ­£åœ¨ä¸‹è½½${res.name}æ¨¡æ¿...`)
      spinner.start()
      const resRepo = res.name === 'react' ? reactRepo : vueRepo
      download(resRepo, `./${res.name}`, {clone: true}, (err) => {
        spinner.stop()
        if (err){
          console.log(chalk.red(err.message))
          process.exit(1)
        }else {
          console.log(chalk.green('ä¸‹è½½æˆåŠŸ'))
          process.exit(0)
        }
      })
    })
  },
  test(opt){
    console.log('ç»“æžœï¼šæµ‹è¯•å‘½ä»¤è¡Œ')
    console.log('å‚æ•°ï¼š',opt)
    console.log('é€‰é¡¹ï¼š', program.try)
  }
}
const catchError = () => {
  console.log(chalk.red('ä½ è¾“å…¥çš„æŒ‡ä»¤ä¸å­˜åœ¨,è¯·æŸ¥çœ‹è¯´æ˜Ž:'))
  shelljs.exec('tang -h')
}
program.version('0.0.1')
program.command('init [param]')
.description('åˆå§‹åŒ–webpackV4é¡¹ç›®(reactæˆ–è€…vue)')
.option('t, --test', 'è¿™åªæ˜¯ä¸€ä¸ªæµ‹è¯•é€‰é¡¹')
.action((env, cmd)=>{
  const cmdName = cmd._name
  if (actionHandle[cmdName]) actionHandle[cmdName](env)
  else {
    catchError()
    process.exit(1)
  }
})
program.arguments('<cmd>').action(cmd=>{
  if (!actionHandle[cmd]) {
    catchError()
    process.exit(1)
  }
})
program.parse(process.argv)